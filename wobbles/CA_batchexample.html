<!DOCTYPE html>
<html>
    <head>
        <title>My experiment</title>
        <script src="global_JS.js"></script>
        <script src="jspsych-6.1.0/jspsych.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="jspsych-6.1.0/plugins/jspsych-audio-keyboard-response.js"></script>
        <script src="jatos.js"></script>
        <link href="jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"></link>
    </head>
    <body>

    </body>
    <script>


    var timeVar = [];

    var hello_trial = {
        type: 'html-keyboard-response',
        stimulus: 'Hello world!',
        on_start: function (trial) {
            // Get prolific id (url var) and the corresponding batch var from jatos and change trial stimulus....
            var prolific_id = jatos.urlQueryParameters.prolific_id
            var pt_index = jatos.batchSession.get(prolific_id)
            trial.stimulus='the participant index for prolificID '+prolific_id+' is '+pt_index ;
        }
    }
    timeVar.push(hello_trial);


    // var audio_stims = stims4all_demo[pt_index].stimlist;
    // console.log(audio_stims)

    // TRIALS -----------------------------------------------------------------

    // var test_trials = {
    //   type: 'audio-keyboard-response',
    //   stimulus: jsPsych.timelineVariable('stimulus'),
    //   choices: ['w', 'n'],
    //   prompt: '<p style="font-size:60px;">+</p>',
    //   response_ends_trial: true,
    //   trial_duration:1050,
    // }
    // var test_procedure = {
    //   timeline: [test_trials],
    //   timeline_variables: audio_stims,
    //   repetitions: 1,
    //   randomize_order: false,
    // }
    // timeVar.push(test_procedure);


    var end_trial = {
        type: 'html-keyboard-response',
        stimulus: 'Thanks....'
    }
    timeVar.push(end_trial);

    // To call the experiment, crate a general multiplr worker batch and add the prolific_id as url var (or let that prolific do for you later, first test with fake ids).
    // Mine looks like:
    // http://127.0.0.1:9000/publix/65/start?batchId=66&generalMultiple&prolific_id=1234567

    function init_experiment(){

        var prolific_id = jatos.urlQueryParameters.prolific_id
        var pt_index = jatos.batchSession.get(prolific_id)
        console.log(pt_index);
        // HOW do I pass pt_index into the experiment as a global variable??? <<<<<<<<<<<<<<<<<<<<<<<<< ?

        jsPsych.init({
            timeline: timeVar,
            on_finish: function() {
                    var resultJson = jsPsych.data.get().json();
                    jatos.submitResultData(resultJson, jatos.startNextComponent);
            }
        })
    }

    jatos.onLoad(function () {
        // Extract url var (here prolific_id)
        var prolific_id=jatos.urlQueryParameters.prolific_id

        if (prolific_id) {

// existing ID
            if (jatos.batchSession.find('/'+prolific_id)) {
                // If, start experiment
                // AIM: If ID exists >>> find participant order in stims4all_demo and select that stim order
                init_experiment();
// new ID
            } else {

                var batchSession = jatos.batchSession.getAll();
                var pt_index = Object.keys(batchSession).length;


                // if not create new batch var with prolific_id as key
                // Cornelius creates an array HERE..
                // AIM: instead of random order_of_trials variable, read the stims4all_demo variable and select row based on participant order
                // order_of_trials = Array(5).fill().map(() => Math.round(Math.random() * 5)); // creat randfom number array
                // var promise = jatos.batchSession.add('/'+prolific_id, order_of_trials); // add to session batch
                var promise = jatos.batchSession.add('/'+prolific_id, pt_index);
                promise.done(() => {
                  // count existing participants INCLDUDING current participant
                        // when batch var is saved successfully LOG and
                        // var batchSession = jatos.batchSession.getAll();
                        // console.log(batchSession);
                        // START EXPERIMENT
                        init_experiment();
                    });
            }

        } else {
            alert('no prolific id given!')
            jatos.abortStudy();
        }

    });
    </script>
</html>
